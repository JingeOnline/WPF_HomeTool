<Page x:Class="WPF_HomeTool.Views.WebViewScraperPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:WPF_HomeTool.Views"
      xmlns:controls="clr-namespace:WPF_HomeTool.Controls"
      xmlns:models="clr-namespace:WPF_HomeTool.Models"
      xmlns:converters="clr-namespace:WPF_HomeTool.Converters"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      mc:Ignorable="d" 
      d:DesignHeight="650" d:DesignWidth="1200"
      Title="WebViewScraperPage">
    <Page.Resources>
        <converters:WebImageDownloadStatusToColorConverter x:Key="StatusToColorConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Page.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="{Binding VM.DataGridLength}"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="auto"/>
        </Grid.RowDefinitions>
        <Grid Visibility="{Binding VM.HeaderVisibility}">
            <controls:PageHeader Grid.Row="0" Title="WebView Scraper" Description="基于WebView2的网页爬虫工具" />
        </Grid>
        <Border Grid.Row="1" Style="{StaticResource MenuBorder}" Visibility="{Binding VM.HeaderVisibility}">
            <Menu >
                <ComboBox Width="140" Margin="0" Padding="0" SelectedValuePath="Content"
                          SelectedValue="{Binding VM.WebSite, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                    <ComboBoxItem Content="ImageFap" IsSelected="True"/>
                    <ComboBoxItem Content="Other1"/>
                    <ComboBoxItem Content="Other2"/>
                </ComboBox>
                <Separator/>
                <TextBox Width="300" VerticalContentAlignment="Center" Text="{Binding VM.UserInputAlbumUri, Mode=TwoWay,UpdateSourceTrigger=PropertyChanged}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding VM.AddAlbumUriCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                <MenuItem Header="添加" Command="{Binding VM.AddAlbumUriCommand}">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconAdd}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="删除" Command="{Binding VM.RemoveSelectedAlbumCommand}">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconRemove}" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="清空" Command="{Binding VM.ClearCommand}">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconClear}" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="重载失败" Command="{Binding VM.LoadUndwonloadWebImageModelsFromSaveCommand}">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconRefresh}" />
                    </MenuItem.Icon>
                </MenuItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="并行数量 " VerticalAlignment="Center"/>
                    <ComboBox VerticalAlignment="Center" ItemsSource="{Binding VM.TabAmountCollection}" SelectedItem="{Binding VM.TabAmount}"/>
                </StackPanel>
                <MenuItem Header="设置">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconSetting}" />
                    </MenuItem.Icon>
                    <Button Content="选择下载路径" VerticalAlignment="Center" Command="{Binding VM.SelectImagesSavePathCommand}"/>
                    <TextBox Width="280" Text="{Binding VM.ImageSavePath,Mode=TwoWay,UpdateSourceTrigger=LostFocus}" />
                    <CheckBox Content="为每个相册创建独立文件夹" IsChecked="{Binding VM.IsNeedCreateAlbumFolder,Mode=TwoWay}"/>
                    <CheckBox Content="下载期间阻止计算机睡眠" IsChecked="{Binding VM.IsPreventComputerSleep,Mode=TwoWay}"/>
                    <Button Content="清除历史记录中未下载的图片" Command="{Binding VM.RemoveAllUndownloadRecordsCommand}"/>
                    <Button Content="在资源管理器中打开下载路径"  Command="{Binding VM.OpenSaveFolderInFileExplorerCommand}"/>
                </MenuItem>
                <Separator/>
                <MenuItem x:Name="StartMenuItem" Header="开始" Click="StartMenuItem_Click">
                    <MenuItem.Icon>
                        <ContentPresenter ContentTemplate="{StaticResource IconDownload}" />
                    </MenuItem.Icon>
                </MenuItem>
            </Menu>
        </Border>
        <Grid Grid.Row="2" Margin="0,8,0,8" Visibility="{Binding VM.HeaderVisibility}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <DataGrid ItemsSource="{Binding VM.WebAlbumModels}" SelectedItem="{Binding VM.SelectedWebAlbumModel}"
                      AutoGenerateColumns="False" IsReadOnly="True" CanUserSortColumns="True" CanUserAddRows="False">
                <DataGrid.Resources>
                    <Style TargetType="DataGridCell">
                        <Setter Property="VerticalAlignment" Value="Center" />
                    </Style>
                </DataGrid.Resources>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Url" Binding="{Binding AlbumUrl}" Width="*"/>
                    <DataGridTextColumn Header="Album Name" Binding="{Binding AlbumName}" Width="*"/>
                    <DataGridTextColumn Header="Images" Binding="{Binding TotalImageCount}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
            <GridSplitter Grid.Column="1" Grid.Row="0" Grid.RowSpan="3" HorizontalAlignment="Stretch" Width="8" Background="Transparent"/>
            <DataGrid Grid.Column="2" ItemsSource="{Binding VM.WebImageModels}" 
                      AutoGenerateColumns="False" IsReadOnly="True" CanUserSortColumns="True" CanUserAddRows="False">
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Setter Property="Background" 
                    Value="{Binding DownloadStatus, Converter={StaticResource StatusToColorConverter}}"/>
                    </Style>
                </DataGrid.RowStyle>
                <DataGrid.Resources>
                    <Style TargetType="DataGridCell">
                        <Setter Property="VerticalAlignment" Value="Center" />
                    </Style>
                </DataGrid.Resources>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Index" Binding="{Binding IndexInAlbum}" Width="auto"/>
                    <DataGridTextColumn Header="Page Url" Binding="{Binding PageUrl}" Width="2*"/>
                    <DataGridTextColumn Header="Status" Binding="{Binding DownloadStatus}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
        <Border Grid.Row="3" Style="{StaticResource MenuBorder}" Padding="0,8,0,0">
            <Grid>
                <TabControl x:Name="WebPageTabControl" ItemsSource="{Binding VM.WebPageTabModels}">
                    <TabControl.ContentTemplate>
                        <DataTemplate>
                            <ContentControl Content="{Binding WebView,Mode=TwoWay}"/>
                            <!--如果使用绑定Source的方法，切换Tab页面后总是重置到默认的首页-->
                            <!--<ContentControl Content="{Binding}">
                                <ContentControl.ContentTemplate>
                                    <DataTemplate>
                                        <wv2:WebView2 Source="{Binding Source}"/>
                                    </DataTemplate>
                                </ContentControl.ContentTemplate>
                            </ContentControl>-->
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                    <TabControl.ItemTemplate>
                        <DataTemplate DataType="models:WebPageTabModel">
                            <TextBlock Text="{Binding Name}"/>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                </TabControl>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
                    <Button Content="人机验证结束" Visibility="{Binding VM.IsNeedHumandValidate,Converter={StaticResource BoolToVisibilityConverter}}"
                            Command="{Binding VM.HumandValidateCompletedCommand}"/>
                    <Button x:Name="WebTabExpandButton" Background="Transparent" BorderBrush="Transparent" 
                        Command="{Binding VM.WebTabExpandCommand}">
                        <TextBlock Text="&#xE93A;" Style="{StaticResource IconTextBlockStyle}"/>
                    </Button>
                </StackPanel>
            </Grid>


        </Border>
        <Border Grid.Row="4" Style="{StaticResource MenuBorder}" Margin="0,8,0,0">
            <Grid Margin="8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="auto"/>
                </Grid.ColumnDefinitions>
                <Grid>
                    <Grid.Style>
                        <Style TargetType="Grid">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ElementName=StatusBarExpandButton, Path=IsChecked}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Grid.Style>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="auto"/>
                        <ColumnDefinition Width="auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding VM.StatusText,Mode=OneWay}" VerticalAlignment="Center">
                        <!--<TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=StatusBarExpandButton, Path=IsChecked}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>-->
                    </TextBlock>
                    <TextBlock Grid.Column="1" Text="{Binding VM.FailedImageCount,StringFormat=失败数量:{0}}" VerticalAlignment="Center" Margin="4,0" HorizontalAlignment="Right"/>
                    <TextBlock Grid.Column="2" Text="{Binding VM.DownloadedImageCount,StringFormat=下载数量:{0}}" VerticalAlignment="Center" Margin="4,0,48,0" HorizontalAlignment="Right"/>
                </Grid>

                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" Height="400">
                    <ScrollViewer.Style>
                        <Style TargetType="ScrollViewer">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ElementName=StatusBarExpandButton, Path=IsChecked}" Value="True">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ScrollViewer.Style>
                    <TextBlock Text="{Binding VM.StatusDetailText,Mode=OneWay}" TextWrapping="Wrap"/>
                </ScrollViewer>

                <ToggleButton x:Name="StatusBarExpandButton" 
                        HorizontalAlignment="Right" VerticalAlignment="Top">
                    <TextBlock Text="&#xE740;" Style="{StaticResource IconTextBlockStyle}"/>
                </ToggleButton>
            </Grid>
        </Border>
    </Grid>
</Page>
